
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng - 3TD Shop</title>
    <link rel="icon" type="image/png" href="Image_Showroom/Slogan_w_logo.png">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts: Rajdhani -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Audiowide&family=Syncopate:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <!-- ✅ Boxicons -->
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <!-- Custom Cyber CSS -->
    <link rel="stylesheet" href="HTML/Style/common.css">
    <link rel="stylesheet" href="HTML/Style/resetcheckout.css">
    <link rel="stylesheet" href="HTML/Style/layout_banners.css">
    <script>
        window.API_BASE = "https://fn-web.onrender.com";
    </script>

    <!-- AuthSync: canonical auth synchronizer (loads early) -->
    <script src="Script/js_authsync.js" defer></script>
    <script src="Script/js_cartcount.js" defer></script>
    <script src="Script/js_ordercount.js" defer></script>
</head>

<body class="cyber-body">
    <div id="header-container"></div>
    <div class="container-fluid checkout-container cyber-main content-narrow">
        <!-- Breadcrumb Steps -->
        <div class="breadcrumb-steps d-flex justify-content-between align-items-center mb-4 p-3 rounded">
            <div class="step active" id="breadcrumb-step-1">
                <i class="fa fa-shopping-cart"></i> Giỏ hàng
            </div>
            <div class="step" id="breadcrumb-step-2">
                <i class="fa fa-truck"></i> Giao hàng
            </div>
            <div class="step" id="breadcrumb-step-3">
                <i class="fa fa-credit-card"></i> Thanh toán
            </div>
        </div>

        <!-- Checkout Step: Cart -->
        <div class="checkout-step cart-step" id="step-1">
            <div class="cart-header mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="cart-title mb-0">Giỏ hàng của bạn</h2>
                    <button class="clear-cart-btn btn btn-danger" id="clear-cart">
                        <i class="fa fa-trash"></i> Xóa tất cả
                    </button>
                </div>
                <div class="select-all-wrapper mt-2 d-flex align-items-center">
                    <input type="checkbox" id="select-all-checkbox" class="form-check-input me-2">
                    <label for="select-all-checkbox" class="text-dark ">Chọn tất cả</label>
                </div>
            </div>

            <!-- Empty Cart -->
            <div class="empty-cart d-flex flex-column align-items-center justify-content-center text-center rounded"
                id="empty-cart">
                <div id="empty-cart-lottie" class="mb-3"></div>
                <h3 class="empty-cart__title">Giỏ hàng của bạn đang trống</h3>
                <p class="empty-cart__message">Hãy khám phá cửa hàng và thêm những sản phẩm yêu thích vào giỏ hàng!</p>
                <a href="index.html" class="continue-shopping btn btn-primary mt-4" id="continue-shopping-btn">Tiếp tục
                    mua sắm</a>
            </div>

            <!-- Cart Items -->
            <div class="cart-items" id="cart-items-container"></div>

            <!-- Cart Summary -->
            <div class="cart-summary p-4 rounded">
                <h3 class="cart-summary__title">Tóm tắt đơn hàng</h3>
                <div class="promo-banner d-flex align-items-center p-3 mb-4 rounded">
                    <i class="fa fa-gift me-2"></i>
                    <p>Miễn phí vận chuyển cho đơn hàng từ 500.000₫</p>
                </div>
                <div class="cart-summary__rows">
                    <div class="summary-row d-flex justify-content-between mb-2">
                        <span class="summary-row__label">Tạm tính:</span>
                        <span class="summary-row__value currency-value">0₫</span>
                    </div>
                    <div class="summary-row d-flex justify-content-between mb-2">
                        <span class="summary-row__label">Phí vận chuyển:</span>
                        <span class="summary-row__value currency-value">Miễn phí</span>
                    </div>
                    <div class="summary-row summary-row--total d-flex justify-content-between mt-3 pt-3">
                        <span class="summary-row__label">Tổng cộng:</span>
                        <span class="summary-row__value currency-value">0₫</span>
                    </div>
                </div>
                <div class="step-navigation d-flex flex-wrap justify-content-between gap-3 mt-4">
                    <a href="index.html" class="btn btn-outline-primary flex-grow-1 text-center">
                        Tiếp tục mua sắm
                    </a>
                    <button class="btn btn-success btn--checkout flex-grow-1 text-center" id="proceed-to-step-2">
                        Đặt hàng ngay
                    </button>
                </div>

            </div>
        </div>

        <!-- Checkout Step: Delivery -->
        <div class="checkout-step delivery-step d-none" id="step-2">
            <h2 class="cart-title mb-4">Thông tin giao hàng</h2>

            <!-- Radio chọn chế độ -->
            <div class="delivery-option d-flex gap-4 mb-3">
                <label class="form-check-label">
                    <input type="radio" name="deliveryMode" value="profile" class="form-check-input" checked>
                    Của bạn
                </label>
                <label class="form-check-label">
                    <input type="radio" name="deliveryMode" value="custom" class="form-check-input">
                    Thông tin khác
                </label>
            </div>

            <!-- Modal nhỏ hiển thị thông tin từ Profile -->
            <div id="profile-delivery-box" class="card p-3 mb-3" style="display:none;">
                <h6 class="fw-bold mb-3">Thông tin giao hàng của bạn</h6>
                <div id="profile-addresses-list"></div>
            </div>

            <!-- Form nhập thông tin khác -->
            <form id="custom-delivery-form" class="delivery-form">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="recipient-name" class="form-label">Họ và tên <i
                                class="fas fa-asterisk text-danger required-icon"></i></label>
                        <input type="text" class="form-control" id="recipient-name">
                    </div>
                    <div class="col-md-6">
                        <label for="recipient-phone" class="form-label">Số điện thoại <i
                                class="fas fa-asterisk text-danger required-icon"></i></label>
                        <input type="tel" class="form-control" id="recipient-phone">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="province" class="form-label">Tỉnh/Thành phố <i
                                class="fas fa-asterisk text-danger required-icon"></i></label>
                        <select id="province" class="form-select">
                            <option value="">-- Chọn Tỉnh/Thành phố --</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="ward" class="form-label">Phường/Xã <i
                                class="fas fa-asterisk text-danger required-icon"></i></label>
                        <select id="ward" class="form-select">
                            <option value="">-- Chọn Phường/Xã --</option>
                        </select>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="recipient-address" class="form-label">Địa chỉ chi tiết <i
                            class="fas fa-asterisk text-danger required-icon"></i></label>
                    <input type="text" class="form-control" id="recipient-address">
                </div>
            </form>

            <!-- Phần luôn hiển thị -->
            <div id="extra-options" class="mt-4">
                <!-- Ghi chú -->
                <div class="mb-3">
                    <label for="note" class="form-label">Ghi chú (tùy chọn)</label>
                    <textarea class="form-control" id="note" rows="2"></textarea>
                </div>

                <!-- Hai checkbox trên cùng 1 hàng -->
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <!-- Xuất hóa đơn -->
                    <div class="form-check mb-0">
                        <input type="checkbox" id="invoice-required" class="form-check-input" checked>
                        <label for="invoice-required" class="form-check-label">Xuất hóa đơn</label>
                    </div>

                    <!-- Đồng ý chính sách -->
                    <div class="form-check mb-0">
                        <input type="checkbox" id="agree-terms" class="form-check-input">
                        <label for="agree-terms" class="form-check-label">
                            Tôi đồng ý với
                            <a href="#" class="text-cyber fw-bold" data-bs-toggle="modal" data-bs-target="#terms-modal">
                                Chính sách &amp; Điều khoản sử dụng
                            </a>
                        </label>
                    </div>
                </div>


                <!-- Nút điều hướng -->
                <div class="step-navigation d-flex justify-content-between gap-3 mt-4">
                    <button type="button" class="btn btn-outline-primary flex-fill" onclick="showStep(1)">Quay
                        lại</button>
                    <button type="button" class="btn btn-success flex-fill" id="proceed-to-step-3">Tiếp tục</button>
                </div>
            </div>

        </div>

        <!-- Checkout Step: Payment -->
        <div class="checkout-step payment-step d-none" id="step-3">
            <h2 class="cart-title mb-4">Xác nhận và thanh toán</h2>
            <div class="payment-content row">
                <div class="summary-section col-lg-7">
                    <div class="info-card p-4 mb-4 rounded">
                        <h3>Thông tin giao hàng</h3>
                        <div class="info-card-content" id="delivery-summary"></div>
                    </div>
                    <div class="info-card p-4 rounded">
                        <h3>Chi tiết đơn hàng</h3>
                        <div id="order-summary"></div>
                    </div>
                </div>

                <div class="payment-section col-lg-5">
                    <div class="payment-card p-4 rounded">
                        <h4>Phương thức thanh toán</h4>
                        <div class="method-option p-3 mb-3 rounded selected cod" data-method="cod">
                            <label for="cod" class="d-flex align-items-center gap-2">
                                <input type="radio" name="payment-method" id="cod" value="cod" checked>
                                <div id="lottie-cod" class="lottie-animation"></div>
                                <span>Thanh toán khi nhận hàng (COD)</span>
                            </label>
                        </div>

                        <p class="payment-note">*Lưu ý: Quý khách chỉ thanh toán sau khi nhận được đơn hàng!</p>
                        <div class="d-flex gap-3 mt-4">
                            <button type="button" class="btn btn-outline-primary flex-fill" onclick="showStep(2)">
                                Quay lại
                            </button>
                            <button class="btn btn-success flex-fill" id="payment-btn" onclick="showConfirmation()">
                                Thanh toán
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="confirmation-modal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content cyber-modal">
                    <h2 class="text-center mb-4">Xác nhận thanh toán</h2>
                    <div id="modal-summary"></div>
                    <div class="modal-buttons d-flex gap-3 mt-4">
                        <button class="modal-btn btn btn-danger flex-fill" onclick="closeModal()">Hủy</button>
                        <button class="modal-btn btn btn-success flex-fill" onclick="processPayment()">Xác nhận</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Loading -->
        <div class="modal fade" id="loading-overlay">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content cyber-modal loading-content">
                    <div id="loading-lottie"></div>
                    <p>Đang xử lý thanh toán...</p>
                </div>
            </div>
        </div>

        <!-- Modal: Payment Success -->
        <div class="modal fade" id="success-modal">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content cyber-modal text-center">
                    <div id="success-lottie" style="width: 150px; height: 150px; margin: 0 auto;"></div>
                    <h2 class="mt-4">Thanh toán thành công!</h2>
                    <p>Cảm ơn bạn đã mua hàng tại 3TD Shop.</p>
                    <button class="modal-btn btn btn-success mt-3" onclick="goToLookup()">OK</button>
                </div>
            </div>
        </div>

        <!-- Modal: Terms and Conditions -->
        <div class="modal fade" id="terms-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content cyber-modal text-light"
                    style="background: rgba(10,10,30,0.95); backdrop-filter: blur(6px); border: 1px solid var(--cyber-primary);">

                    <h2 class="text-center mb-3">Chính sách & Điều khoản 3TDShop</h2>

                    <div style="max-height: 400px; overflow-y: auto;" class="terms-body px-3">
                        <p>
                            Tại <strong>3TDShop</strong>, chúng tôi mong muốn mang lại trải nghiệm mua sắm trực tuyến
                            <em>dễ dùng – dễ tương tác – dễ kết nối</em>, đồng thời đảm bảo quyền lợi và sự an toàn dữ
                            liệu cho khách hàng.
                        </p>

                        <h5 class="mt-3 text-cyber">1. Bảo mật & xử lý dữ liệu</h5>
                        <ul>
                            <li>Thông tin cá nhân được thu thập chỉ nhằm phục vụ đơn hàng & chăm sóc khách hàng.</li>
                            <li>Mọi dữ liệu đều được bảo mật, không chia sẻ cho bên thứ ba khi chưa có sự đồng ý của
                                bạn.</li>
                            <li>Bạn có quyền yêu cầu chỉnh sửa hoặc <u>xóa dữ liệu</u> khi không còn sử dụng dịch vụ.
                            </li>
                        </ul>

                        <h5 class="mt-3 text-cyber">2. Trách nhiệm của khách hàng</h5>
                        <ul>
                            <li>Cung cấp thông tin chính xác (họ tên, số điện thoại, địa chỉ).</li>
                            <li>Kiểm tra kỹ giỏ hàng và đơn hàng trước khi xác nhận.</li>
                            <li>Tôn trọng các quy định mua sắm và thanh toán của hệ thống.</li>
                        </ul>

                        <h5 class="mt-3 text-cyber">3. Xuất hóa đơn theo yêu cầu</h5>
                        <ul>
                            <li>Hóa đơn chỉ được phát hành nếu bạn <strong>tích chọn “Xuất hóa đơn”</strong> trước khi
                                hoàn tất đặt hàng.</li>
                            <li>Thông tin xuất hóa đơn cần chính xác ngay tại thời điểm mua hàng.</li>
                            <li>Hóa đơn điện tử sẽ được gửi qua email đã đăng ký.</li>
                            <li>3TDShop không cấp lại hóa đơn nếu bạn bỏ chọn lúc đầu.</li>
                        </ul>

                        <h5 class="mt-3 text-cyber">4. Cam kết dịch vụ</h5>
                        <p>
                            Chúng tôi luôn nỗ lực tối đa để mang lại trải nghiệm mua sắm an toàn và tiện lợi.
                            Mọi thắc mắc hoặc khiếu nại, vui lòng liên hệ bộ phận <strong>Hỗ trợ khách hàng
                                24/7</strong> qua hotline hoặc email.
                        </p>
                    </div>

                    <div class="modal-buttons d-flex justify-content-center mt-4">
                        <button class="btn btn-success" data-bs-dismiss="modal">Tôi đã hiểu</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal: Cảnh báo chưa đồng ý -->
        <div class="modal fade" id="must-agree-modal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content cyber-modal text-light text-center"
                    style="background: rgba(20,20,40,0.95); backdrop-filter: blur(6px); border: 1px solid #ffcc00; box-shadow: 0 0 12px rgba(255, 204, 0, 0.5);">

                    <h4 class="mb-3 text-warning">
                        <i class="fa fa-exclamation-triangle me-2"></i> Thông báo từ 3TDShop
                    </h4>

                    <p class="px-3">
                        Bạn cần <strong>đọc và đồng ý</strong> với
                        <span class="text-cyber">Chính sách &amp; Điều khoản sử dụng</span>
                        của dịch vụ <span class="fw-bold text-cyber">3TDShop</span> trước khi tiếp tục.
                    </p>
                    <p class="px-3">
                        Việc này nhằm đảm bảo quyền lợi và sự bảo mật thông tin cho bạn.
                    </p>

                    <div class="modal-buttons d-flex justify-content-center mt-4">
                        <button class="btn btn-warning px-4 fw-bold" data-bs-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="footer-container"></div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Bootstrap 5 JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>
    <!-- Lottie Animation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Tom Select CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css"
        rel="stylesheet" />
    <!-- Tom Select JS -->
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <!-- Custom JS -->
    <script src="Script/js_header.js" defer></script>
    <script src="Script/js_resetcheckout.js" defer></script>

    <!-- Inject auth script AFTER header; refresh only; KHÔNG auto-open modal -->
    <script>
        (function () {
            let authInjected = false;

            function injectAuth() {
                if (authInjected) return;
                authInjected = true;

                const s = document.createElement('script');
                s.src = "Script/js_resetauth.js";
                s.defer = true;
                s.onload = async function () {
                    try {
                        if (window.AuthSync && typeof window.AuthSync.refresh === 'function') {
                            await window.AuthSync.refresh();
                        }
                    } catch (err) {
                        console.warn('AuthSync.refresh() failed on checkout page:', err);
                    }

                    // ----- Update header/cart/orders -----
                    try {
                        if (typeof updateUserDisplay === 'function') await updateUserDisplay();
                        if (typeof updateCartCount === 'function') updateCartCount();
                        if (typeof updateOrderCount === 'function') updateOrderCount();
                    } catch (e) {
                        console.warn('Post-refresh header update (checkout) failed:', e);
                    }
                    // NOTE: KHÔNG tiêu thụ flag & KHÔNG mở modal tự động
                };
                document.body.appendChild(s);
            }

            const headerContainer = document.getElementById('header-container');
            if (headerContainer && headerContainer.children.length > 0) {
                injectAuth();
            } else if (headerContainer) {
                const obs = new MutationObserver((mutations, observer) => {
                    for (const m of mutations) {
                        if (m.type === 'childList' && m.addedNodes.length > 0) {
                            injectAuth();
                            observer.disconnect();
                            return;
                        }
                    }
                });
                obs.observe(headerContainer, { childList: true, subtree: false });
                setTimeout(() => { try { obs.disconnect(); } catch (e) { } if (!authInjected) injectAuth(); }, 3500);
            } else {
                let tries = 0;
                const t = setInterval(() => {
                    const hc = document.getElementById('header-container');
                    tries++;
                    if (hc && hc.children.length > 0) {
                        clearInterval(t);
                        injectAuth();
                    } else if (tries > 40) {
                        clearInterval(t);
                        injectAuth();
                    }
                }, 100);
            }
        })();
    </script>
</body>

</html>